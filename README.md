

## ğŸ“ è¦ä»¶ã®æ•´ç†

### ğŸ¯ ç›®çš„

**äºŒæ¬¡å…ƒé…åˆ—Aï¼ˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼‰**ã¨**é…åˆ—Bï¼ˆç´å“ãƒ‡ãƒ¼ã‚¿ï¼‰**ã‚’ã€å„ç´å“ãŒã©ã®æ³¨æ–‡ã«å¯¾å¿œã™ã‚‹ã‹ã‚’ç‰¹å®šã—ã€çµåˆï¼ˆãƒãƒƒãƒãƒ³ã‚°ï¼‰ã•ã›ã‚‹ã€‚

---

### ğŸ“¥ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿

| é…åˆ—å | æ¦‚è¦ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ |
| :--- | :--- | :--- |
| **é…åˆ—A** (æ³¨æ–‡) | å“ç•ªã”ã¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ | æ³¨æ–‡NO (13æ¡ãƒ¦ãƒ‹ãƒ¼ã‚¯)ã€**å“ç•ª**ã€**æ•°é‡**ã€**ç´æœŸ** |
| **é…åˆ—B** (ç´å“) | å“ç•ªã”ã¨ã®å€‰åº«ç´å“ãƒ‡ãƒ¼ã‚¿ | **å“ç•ª**ã€å€‰åº«ç•ªå· (6ã‹æ‰€)ã€**ç´å“æ—¥**ã€**æ•°é‡** |

---

### ğŸ§© ãƒãƒƒãƒãƒ³ã‚°ã®èª²é¡Œã¨åˆ¶ç´„

* **å¤šå¯¾å¤šã®é–¢ä¿‚:** ä¸€ã¤ã®æ³¨æ–‡ã«å¯¾ã—ã€ç´å“ã¯è¤‡æ•°ã®å€‰åº«ã«åˆ†ã‹ã‚Œã€è¤‡æ•°å›ã«ã°ã‚‰ã¤ãå¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
* **åŒå“ç•ªãƒ»åˆ¥æ¡ä»¶ã®æ³¨æ–‡:** åŒã˜å“ç•ªã§ã‚‚ã€ç´æœŸã‚„æ•°é‡ãŒç•°ãªã‚‹è¤‡æ•°ã®æ³¨æ–‡ãŒå­˜åœ¨ã™ã‚‹ã€‚
* **èª¤å·®ã®è¨±å®¹:** æ³¨æ–‡æ•°é‡ã¨ç´å“æ•°é‡ã€ãŠã‚ˆã³æ³¨æ–‡ç´æœŸã¨ç´å“æ—¥ã®é–“ã«ã€**è‹¥å¹²ã®èª¤å·®**ã‚„**ã¾ã‚Œã«å¤§ããªèª¤å·®**ï¼ˆç‰¹ã«ç´æœŸï¼‰ãŒã‚ã‚‹ã€‚
* **ç´æœŸé€†è»¢ã®å¯èƒ½æ€§:** æ³¨æ–‡ç´æœŸãŒå¾Œã®ã‚‚ã®ã«ã€ç´å“ãŒå…ˆã«è¿‘ã„æ—¥ä»˜ã§ã•ã‚Œã‚‹ï¼ˆç´æœŸé…ã‚Œã«ã‚ˆã‚Šï¼‰ã¨ã„ã£ãŸ**ç´æœŸã®å‰å¾Œé€†è»¢ç¾è±¡**ã‚‚è€ƒæ…®ãŒå¿…è¦ã€‚
* **ç´å“é †ã®åˆ¶ç´„:** ç´å“ãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—Bï¼‰ã‚’æ³¨æ–‡ã«å‰²ã‚Šå½“ã¦ã‚‹éš›ã€ã€Œ**ç´å“æ—¥ã¯ç´å“æ—¥ã®é †ç•ªé€šã‚Šã«ä¸¦ã¹ã‚‹**ã€å¿…è¦ãŒã‚ã‚‹ï¼ˆå¾Œã‹ã‚‰ç´å“ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã€å…ˆã«ç´å“ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šã‚‚å‰ã®æ³¨æ–‡ç´æœŸã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯è€ƒæ…®ã—ãªã„ï¼‰ã€‚

---

### ğŸ’¡ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŸºæœ¬æ–¹é‡ï¼ˆææ¡ˆï¼‰

1.  **å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼ˆãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯/å†å¸°ï¼‰:**
    * **å“ç•ª**ãŒä¸€è‡´ã™ã‚‹é…åˆ—Aã®æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã¨é…åˆ—Bã®ç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦ã€é…åˆ—Bã®ç´å“ãƒ‡ãƒ¼ã‚¿ã‚’ã€é…åˆ—Aã®æ³¨æ–‡æ•°ã«å¯¾å¿œã•ã›ã¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã™ã‚‹ã€‚
    * **ç´å“é †ã®åˆ¶ç´„**ï¼ˆç´å“æ—¥ã¯ç´å“æ—¥ã®é †ç•ªé€šã‚Šï¼‰ã‚’å³å®ˆã—ã¤ã¤ã€ç´å“ãƒ‡ãƒ¼ã‚¿å…¨ã¦ã‚’æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã‚‹**å…¨çµ„ã¿åˆã‚ã›**ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆç´å“ãŒå…¨ããªã„æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚è€ƒæ…®ï¼‰ã€‚
2.  **ç‚¹æ•°è©•ä¾¡ï¼ˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰:**
    * ç”Ÿæˆã•ã‚ŒãŸ**å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³**ã«ã¤ã„ã¦ã€å¾Œè¿°ã®ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ã**ç‚¹æ•°**ã‚’è¨ˆç®—ã™ã‚‹ã€‚
3.  **æœ€è‰¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠ:**
    * æœ€ã‚‚ç‚¹æ•°ãŒé«˜ã„çµ„ã¿åˆã‚ã›ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’ã€Œæ­£è§£ã€ã¨ã—ã¦æ¡ç”¨ã™ã‚‹ã€‚

---

## ğŸ”¢ ç‚¹æ•°ä»˜ã‘ï¼ˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰ãƒ­ã‚¸ãƒƒã‚¯ã®ææ¡ˆ

æœ€è‰¯ã®çµ„ã¿åˆã‚ã›ã‚’é¸ã¶ãŸã‚ã®ç‚¹æ•°ï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã¯ã€**èª¤å·®ãŒå°ã•ã„ã»ã©é«˜ããªã‚‹**ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®2ã¤ã®è¦ç´ ã§æ§‹æˆã—ã¾ã™ã€‚

### 1. æ•°é‡èª¤å·®ã®ç‚¹æ•° (Weight: é«˜)

**æ³¨æ–‡æ•°é‡**ã¨**å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“æ•°é‡ã®åˆè¨ˆ**ã®å·®ã«åŸºã¥ã„ã¦ç‚¹æ•°ã‚’ä»˜ã‘ã¾ã™ã€‚æ•°é‡ã¯æœ€ã‚‚é‡è¦è¦–ã™ã¹ãè¦ç´ ã®ä¸€ã¤ã§ã™ã€‚

* **è¨ˆç®—å¼:** $\text{Score}_{\text{æ•°é‡}} = \sum_{\text{å…¨æ³¨æ–‡}} \left( \text{æœ€å¤§ç‚¹æ•°} \times \frac{1}{| \text{æ³¨æ–‡æ•°é‡} - \text{ç´å“åˆè¨ˆæ•°é‡}| + \epsilon} \right)$
    * ã¾ãŸã¯ã€ã‚ˆã‚Šç›´æ„Ÿçš„ã«ï¼š$\text{Score}_{\text{æ•°é‡}} = \sum_{\text{å…¨æ³¨æ–‡}} \text{MaxScore}_{\text{Q}} - (\text{ä¿‚æ•°} \times |\text{æ³¨æ–‡æ•°é‡} - \text{ç´å“åˆè¨ˆæ•°é‡}|)$
* **ãƒ­ã‚¸ãƒƒã‚¯:**
    * **èª¤å·®ã‚¼ãƒ­**ï¼ˆæ•°é‡ãŒå®Œå…¨ã«ä¸€è‡´ï¼‰ã®å ´åˆã«**æœ€é«˜ç‚¹**ã‚’ä¸ãˆã¾ã™ã€‚
    * èª¤å·®ãŒå¤§ãããªã‚‹ã»ã©ã€ç‚¹æ•°ãŒæ€¥æ¿€ã«ä¸‹ãŒã‚‹ã‚ˆã†ã«**ãƒšãƒŠãƒ«ãƒ†ã‚£**ã‚’è¨­å®šã—ã¾ã™ã€‚
    * **$\epsilon$** (ã‚¤ãƒ—ã‚·ãƒ­ãƒ³: éå¸¸ã«å°ã•ãªå€¤) ã¯åˆ†æ¯ãŒã‚¼ãƒ­ã«ãªã‚‹ã®ã‚’é˜²ããŸã‚ã§ã™ã€‚

### 2. ç´æœŸèª¤å·®ã®ç‚¹æ•° (Weight: ä¸­ã€œé«˜)

**æ³¨æ–‡ç´æœŸ**ã¨**å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“æ—¥**ã®å·®ã«åŸºã¥ã„ã¦ç‚¹æ•°ã‚’ä»˜ã‘ã¾ã™ã€‚

* **åŸºæœ¬ã®è¨ˆç®—å¼:** $\text{Score}_{\text{ç´æœŸ}} = \sum_{\text{å…¨æ³¨æ–‡}} \left( \sum_{\text{å‰²ã‚Šå½“ã¦ç´å“}} \text{MaxScore}_{\text{D}} - (\text{ä¿‚æ•°} \times |\text{æ³¨æ–‡ç´æœŸ} - \text{ç´å“æ—¥}|) \right)$
* **ãƒ­ã‚¸ãƒƒã‚¯:**
    * **ç´æœŸé€šã‚Š**ï¼ˆèª¤å·®ã‚¼ãƒ­ï¼‰ã®å ´åˆã«**æœ€é«˜ç‚¹**ã‚’ä¸ãˆã¾ã™ã€‚
    * èª¤å·®ã®æ—¥æ•°ãŒå¤§ãã„ã»ã©ç‚¹æ•°ã‚’ä¸‹ã’ã¾ã™ã€‚
    * **ç´æœŸã®é…ã‚Œï¼ˆãƒã‚¤ãƒŠã‚¹è©•ä¾¡ï¼‰**ã¨**ç´æœŸã®æ—©ã™ãï¼ˆãƒã‚¤ãƒŠã‚¹è©•ä¾¡ï¼‰**ã§ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ã®ä¿‚æ•°ã‚’å¤‰ãˆã‚‹ã“ã¨ã‚‚æœ‰åŠ¹ã§ã™ï¼ˆä¾‹: é…å»¶ã®æ–¹ãŒãƒšãƒŠãƒ«ãƒ†ã‚£å¤§ï¼‰ã€‚
    * **ç´æœŸé€†è»¢ã®è€ƒæ…®:** ç´å“é †ã®åˆ¶ç´„ã«ã‚ˆã‚Šã€åŸºæœ¬çš„ã«ã¯ç´å“æ—¥ã®é †åºã‚’ä¿ã¡ã¾ã™ãŒã€**ã€Œæ³¨æ–‡ç´æœŸãŒå¾Œã®ã‚‚ã®ã«ã€ç´æœŸé…ã‚Œã«ã‚ˆã‚Šè¿‘ã„æ—¥ä»˜ã§ç´å“ã•ã‚Œã‚‹ã€**çŠ¶æ³ã¯ã€ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ¯”è¼ƒã—ã¦ç‚¹æ•°ã‚’é«˜ãã—ã¾ã™ã€‚

### 3. ç·åˆç‚¹æ•°

**ç·åˆç‚¹æ•°** = ($\text{æ•°é‡ã®é‡ã¿} \times \text{Score}_{\text{æ•°é‡}}$) + ($\text{ç´æœŸã®é‡ã¿} \times \text{Score}_{\text{ç´æœŸ}}$)

* **é‡ã¿ä»˜ã‘:** æ•°é‡ã®èª¤å·®ãŒç´æœŸèª¤å·®ã‚ˆã‚Šã‚‚ãƒ“ã‚¸ãƒã‚¹ä¸Šé‡è¦ã§ã‚ã‚Œã°ã€**æ•°é‡ã®é‡ã¿ $>$ ç´æœŸã®é‡ã¿**ã¨è¨­å®šã—ã¾ã™ã€‚

---





ãŠæ±‚ã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã€**æ³¨æ–‡ï¼ˆé…åˆ—Aï¼‰ã¨ç´å“ï¼ˆé…åˆ—Bï¼‰ã®æœ€é©ãƒãƒƒãƒãƒ³ã‚°å•é¡Œ**ã¨ã—ã¦æ‰ãˆã‚‰ã‚Œã¾ã™ã­ã€‚ã“ã‚Œã¯ã€åˆ¶ç´„ä»˜ãã®å‰²ã‚Šå½“ã¦å•é¡Œã§ã‚ã‚Šã€ç‰¹ã«ã€Œå…¨çµ„ã¿åˆã‚ã›ã‚’è©•ä¾¡ã—ã¦æœ€é©è§£ã‚’é¸ã¶ã€ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€**ã€Œãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ãªæœ€é©åŒ–ã€**ã¾ãŸã¯**ã€Œã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«åŸºã¥ãå‰²ã‚Šå½“ã¦ã€**ã¨ã—ã¦è¨­è¨ˆã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚

å®Ÿç¾ã—ãŸã„ãƒ­ã‚¸ãƒƒã‚¯ã¨è¤‡é›‘ã•ã‚’è€ƒæ…®ã™ã‚‹ã¨ã€ã“ã‚Œã¯å˜ç´”ãªVBAã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¶…ãˆãŸã€**ã€Œã‚³ã‚¹ãƒˆï¼ˆèª¤å·®ï¼‰æœ€å°åŒ–ã€**ã‚’ç›®æŒ‡ã™ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ’¡ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ¦‚è¦

ã“ã®å•é¡Œã®éµã¯ã€ç´å“ï¼ˆé…åˆ—Bï¼‰ã‚’è¤‡æ•°ã®æ³¨æ–‡ï¼ˆé…åˆ—Aï¼‰ã«ã€Œåˆ†å‰²ãƒ»å‰²ã‚Šå½“ã¦ã€ã™ã‚‹**å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’ç”Ÿæˆã—ã€ãã‚Œãã‚Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’**ã‚¹ã‚³ã‚¢ï¼ˆç‚¹æ•°ï¼‰**ã§è©•ä¾¡ã—ã€æœ€ã‚‚é«˜ã„ã‚¹ã‚³ã‚¢ï¼ˆæœ€ã‚‚èª¤å·®ãŒå°‘ãªã„ï¼‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã€Œæ­£è§£ã€ã¨ã—ã¦æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

### 1. **äº‹å‰æº–å‚™ã¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ **

* **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®çµ±ä¸€:** é…åˆ—Aã€Bã‚’å‡¦ç†ã—ã‚„ã™ã„ã‚ˆã†ã«ã€å“ç›®ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€ä¾‹ãˆã°`Collection`ã‚„`Dictionary`ã«æ ¼ç´ã—ã¾ã™ã€‚
* **ã‚½ãƒ¼ãƒˆ:** å‡¦ç†ã®å‰æã¨ãªã‚‹åˆ¶ç´„ï¼ˆã€Œç´å“æ—¥ã¯ç´å“æ—¥ã®é †ç•ªé€šã‚Šã«ä¸¦ã¹ã‚‹ã€ï¼‰ã‚’æº€ãŸã™ãŸã‚ã€**é…åˆ—Bï¼ˆç´å“ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ã€Œç´å“æ—¥ã€ã§æ˜‡é †ã‚½ãƒ¼ãƒˆ**ã—ã¾ã™ã€‚
* **åˆ¶ç´„:** ãƒãƒƒãƒãƒ³ã‚°ã¯**åŒã˜å“ç•ª**å†…ã§è¡Œã„ã¾ã™ã€‚

### 2. **å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°/å†å¸°ï¼‰**

å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã¯ã€**å†å¸°é–¢æ•°ï¼ˆBacktrackingï¼‰**ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

* **è€ƒãˆæ–¹:** ç´å“ãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—Bï¼‰ã‚’å…ˆé ­ã‹ã‚‰ä¸€ã¤ãšã¤è¦‹ã¦ã„ãã€ãã‚Œã‚’**ã€Œã©ã®æ³¨æ–‡ï¼ˆé…åˆ—Aï¼‰ã«å‰²ã‚Šå½“ã¦ã‚‹ã‹ã€**ã€ã¾ãŸã¯**ã€Œç‹¬ç«‹ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã¨ã™ã‚‹ã‹ã€**ã®é¸æŠã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

    * `ç´å“ãƒ‡ãƒ¼ã‚¿ B[i]` ã‚’ã€`æ³¨æ–‡ A[j]` ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã‚‹ã€‚
    * **åˆ¶ç´„:** å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹`æ³¨æ–‡ A[j]`ã¯ã€`B[i]`ã‚ˆã‚Šå‰ã®ç´å“ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ`æ³¨æ–‡ A[k]`ã‚ˆã‚Šã‚‚**æ³¨æ–‡ç´æœŸãŒå¾Œ**ã§ã‚ã‚‹ã‹ã€**åŒã˜**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆã€Œå‰ã«ç´å“ã—ãŸã‚‚ã®ãŒå¾Œã«ç´å“ã—ãŸã‚‚ã®ã‚ˆã‚Šã‚‚ã€æ³¨æ–‡ç´æœŸãŒå¾Œã‚ã«ãªã‚‹å ´åˆã¯è€ƒãˆãªã„ã€ï¼‰

* **çµæœã®æ ¼ç´:** ç”Ÿæˆã•ã‚ŒãŸã™ã¹ã¦ã®æœ‰åŠ¹ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç´å“ã®ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼‰ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼š`Collection`ï¼‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

### 3. **ãƒ‘ã‚¿ãƒ¼ãƒ³è©•ä¾¡ã¨ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆç‚¹æ•°å¼ï¼‰**

å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã€**æ³¨æ–‡ã¨ç´å“ã®èª¤å·®**ã‚’ç®—å‡ºã—ã€ãã®åˆè¨ˆãŒæœ€ã‚‚å°ã•ããªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚

---

## ğŸ¯ ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆç‚¹æ•°ï¼‰ã®è¨­è¨ˆ

ã‚¹ã‚³ã‚¢ã¯ã€**èª¤å·®ãŒå°ã•ã„ã»ã©é«˜å¾—ç‚¹**ã¨ãªã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ã€‚è¤‡æ•°ã®è¦ç´ ã‚’è€ƒæ…®ã™ã‚‹ãŸã‚ã€ãã‚Œãã‚Œã®èª¤å·®ã«**é‡ã¿**ã‚’ä»˜ã‘ã¦åˆè¨ˆã—ã¾ã™ã€‚

**ç›®æ¨™: $\text{Total Score} = W_{\text{Qty}} \times \text{Score}_{\text{Qty}} + W_{\text{Date}} \times \text{Score}_{\text{Date}}$ ã‚’æœ€å¤§åŒ–**

### 1. æ•°é‡èª¤å·®ã®ã‚¹ã‚³ã‚¢ ($\text{Score}_{\text{Qty}}$)

æ•°é‡èª¤å·®ã¯ã€**ã€Œæ³¨æ–‡æ•°é‡ã®åˆè¨ˆã€ã¨ã€Œå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“æ•°é‡ã®åˆè¨ˆã€ã®å·®**ã§ç®—å‡ºã—ã¾ã™ã€‚

| è©•ä¾¡æŒ‡æ¨™ | è¨ˆç®—å¼ |
| :--- | :--- |
| **æ•°é‡ã®çµ¶å¯¾èª¤å·®** ($\text{Abs\_Qty\_Error}$) | $\lvert \text{æ³¨æ–‡æ•°é‡} - \sum \text{ç´å“æ•°é‡} \rvert$ |
| **æ•°é‡ã‚¹ã‚³ã‚¢** ($\text{Score}_{\text{Qty}}$) | $1 / (1 + \text{Abs\_Qty\_Error})$ |

* **å‚™è€ƒ:** èª¤å·®ãŒ0ã®ã¨ãã‚¹ã‚³ã‚¢ã¯1ã€èª¤å·®ãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦ã‚¹ã‚³ã‚¢ã¯0ã«è¿‘ã¥ãã¾ã™ã€‚

### 2. ç´æœŸèª¤å·®ã®ã‚¹ã‚³ã‚¢ ($\text{Score}_{\text{Date}}$)

ç´æœŸèª¤å·®ã¯ã€**ã€Œæ³¨æ–‡ç´æœŸã€ã¨ã€Œå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®å¹³å‡ç´å“æ—¥ã€**ã®å·®ã§ç®—å‡ºã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚

| è©•ä¾¡æŒ‡æ¨™ | è¨ˆç®—å¼ |
| :--- | :--- |
| **å¹³å‡ç´å“æ—¥** ($\text{Avg\_Delv\_Date}$) | $\sum (\text{ç´å“æ—¥}) / (\text{ç´å“ä»¶æ•°})$ |
| **æ—¥æ•°ã®çµ¶å¯¾èª¤å·®** ($\text{Abs\_Date\_Error}$) | $\lvert \text{æ³¨æ–‡ç´æœŸ} - \text{Avg\_Delv\_Date} \rvert$ (å˜ä½ï¼šæ—¥æ•°) |
| **ç´æœŸã‚¹ã‚³ã‚¢** ($\text{Score}_{\text{Date}}$) | $\text{Base} / ( \text{Base} + \text{Abs\_Date\_Error}^p)$ |

* **$p$ (ã¹ãä¹—):** $p=1$ãªã‚‰ç·šå½¢ã€$p=2$ãªã‚‰äºŒä¹—ã§èª¤å·®ã‚’è©•ä¾¡ã—ã¾ã™ã€‚å¤§ããªèª¤å·®ã‚’å³ã—ãè©•ä¾¡ã—ãŸã„å ´åˆã¯$p=2$ãªã©ã¨ã—ã¾ã™ã€‚
* **$\text{Base}$ (åŸºæº–å€¤):** ã‚¹ã‚³ã‚¢ã®æ„Ÿåº¦ã‚’èª¿æ•´ã™ã‚‹å€¤ã€‚ç´æœŸèª¤å·®ãŒ$\text{Base}$æ—¥æ•°ã¨åŒã˜ã¨ãã€ã‚¹ã‚³ã‚¢ãŒ0.5ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚

### 3. **é‡ã¿ä»˜ã‘ã¨åˆè¨ˆ**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | æ±ºå®šã®ç›®å®‰ |
| :--- | :--- | :--- |
| **$W_{\text{Qty}}$** | æ•°é‡ã‚¹ã‚³ã‚¢ã®é‡ã¿ | æ•°é‡èª¤å·®ã‚’ç´æœŸèª¤å·®ã‚ˆã‚Šé‡è¦è¦–ã™ã‚‹ãªã‚‰ã€$W_{\text{Qty}} > W_{\text{Date}}$ |
| **$W_{\text{Date}}$** | ç´æœŸã‚¹ã‚³ã‚¢ã®é‡ã¿ | ç´æœŸèª¤å·®ã‚’æ•°é‡èª¤å·®ã‚ˆã‚Šé‡è¦è¦–ã™ã‚‹ãªã‚‰ã€$W_{\text{Date}} > W_{\text{Qty}}$ |

* **æœ€çµ‚çš„ãªã‚¹ã‚³ã‚¢ (Total Score):** å„æ³¨æ–‡ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚³ã‚¢ã®**åˆè¨ˆ**ï¼ˆã¾ãŸã¯**å¹³å‡**ï¼‰ã‚’ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ã‚³ã‚¢ã¨ã—ã¾ã™ã€‚

---

## ğŸ’» VBAã«ã‚ˆã‚‹å®Ÿè£…ã®ä¸»è¦ãªã‚¹ãƒ†ãƒƒãƒ—

1.  **ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨æ•´å½¢:**
    * é…åˆ—Aã¨Bã‹ã‚‰ã€**å“ç•ªã”ã¨**ã®ãƒªã‚¹ãƒˆï¼ˆ`Collection`ã¾ãŸã¯`Dictionary`ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
    * é…åˆ—Bã®ç´å“ãƒ‡ãƒ¼ã‚¿ã‚’ç´å“æ—¥ã§ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚
2.  **å†å¸°é–¢æ•°ï¼ˆBacktrackingï¼‰ã®å®šç¾©:**
    * `Sub FindAllPatterns(ByVal DeliveryIndex As Long, CurrentPattern As Collection, AllPatterns As Collection)`
    * `DeliveryIndex`: æ¬¡ã«å‡¦ç†ã™ã‚‹ç´å“ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚
    * `CurrentPattern`: ç¾åœ¨æ§‹ç¯‰ä¸­ã®å‰²ã‚Šå½“ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚
    * `AllPatterns`: è¦‹ã¤ã‹ã£ãŸå…¨ã¦ã®æœ‰åŠ¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ ¼ç´ã™ã‚‹`Collection`ã€‚
3.  **ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°ã®å®šç¾©:**
    * `Function CalculatePatternScore(ByVal Pattern As Collection) As Double`
    * ä¸Šè¨˜**ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®è¨­è¨ˆ**ã«åŸºã¥ã„ã¦ã€æ•°é‡ã¨ç´æœŸã®èª¤å·®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã€åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¿”ã—ã¾ã™ã€‚
4.  **æœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠ:**
    * `AllPatterns`ã®ä¸­ã‹ã‚‰ã€`CalculatePatternScore`ãŒè¿”ã™å€¤ãŒ**æœ€å¤§**ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸ã³ã¾ã™ã€‚
5.  **çµæœã®å‡ºåŠ›:**
    * é¸ã°ã‚ŒãŸæœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã€é…åˆ—Aã¨é…åˆ—Bã‚’çµåˆã—ãŸæœ€çµ‚çµæœï¼ˆæ³¨æ–‡NOã€å“ç•ªã€æ•°é‡ã€ç´æœŸã€å€‰åº«ç•ªå·ã€ç´å“æ—¥ã€ç´å“æ•°é‡ï¼‰ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

---

ç´æœŸã®ã€Œå¤§ããªèª¤å·®ã€ã‚„ã€Œç´æœŸã®å‰å¾Œé–¢ä¿‚ã®é€†è»¢ã€ã¾ã§ã‚’è€ƒæ…®ã§ãã‚‹ã®ãŒã€ã“ã®**å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³è©•ä¾¡æ–¹å¼**ã®å¼·ã¿ã§ã™ã€‚ãŸã ã—ã€æ³¨æ–‡æ•°ã‚„ç´å“æ•°ãŒéå¸¸ã«å¤šã„å ´åˆã€çµ„ã¿åˆã‚ã›æ•°ãŒçˆ†ç™ºçš„ã«å¢—ãˆã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹**ï¼ˆè¨ˆç®—é‡ã®å•é¡Œï¼‰**ç‚¹ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚





æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã”æç¤ºã„ãŸã ã„ãŸè¤‡é›‘ãªæ¡ä»¶ã‚’æº€ãŸã™ã€**å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆã¨ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«åŸºã¥ãæœ€é©ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **ã‚’VBAã§å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰è¨­è¨ˆæ¡ˆã¨ã€ä¸»è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯è¤‡é›‘ãªãŸã‚ã€\*\*ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚¯ãƒ©ã‚¹ï¼‰\*\*ã‚’åˆ†ã‘ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ã¨å¯èª­æ€§ã‚’é«˜ã‚ã¾ã™ã€‚

-----

## ğŸ’» VBAã‚³ãƒ¼ãƒ‰è¨­è¨ˆæ¡ˆ

### 1\. ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (Class Modules) ã®ä½œæˆ

ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€3ã¤ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

  * `ClsOrder`: é…åˆ—Aã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå“ç•ªã€æ³¨æ–‡NOã€æ•°é‡ã€ç´æœŸï¼‰ã‚’ä¿æŒã€‚
  * `ClsDelivery`: é…åˆ—Bã®ç´å“ãƒ‡ãƒ¼ã‚¿ï¼ˆå“ç•ªã€å€‰åº«ç•ªå·ã€ç´å“æ—¥ã€æ•°é‡ï¼‰ã‚’ä¿æŒã€‚
  * `ClsMatchPattern`: 1ã¤ã®æ³¨æ–‡ã«å¯¾ã™ã‚‹ç´å“å‰²ã‚Šå½“ã¦ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã‚’ä¿æŒã—ã€ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’æ‹…å½“ã€‚

### 2\. æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (Standard Module) ã®ä½œæˆ

ä¸»è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã¨å®Ÿè¡Œé–¢æ•°ã‚’æ ¼ç´ã—ã¾ã™ã€‚

  * `MdlMatcher`: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã€ã‚½ãƒ¼ãƒˆã€**å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼ˆå†å¸°å‡¦ç†ï¼‰**ã€æœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠã‚’æ‹…å½“ã€‚

-----

## ğŸ› ï¸ VBAã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…

ã“ã“ã§ã¯ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ ¸ã¨ãªã‚‹**ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°**ã¨**å†å¸°çš„ãªãƒãƒƒãƒãƒ³ã‚°é–¢æ•°**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦å®Ÿè£…ã—ã¾ã™ã€‚

### 1\. ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼ˆMdlMatcherå†…ï¼‰

ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®é‡ã¿ã¨æ„Ÿåº¦ã‚’è¨­å®šã—ã¾ã™ã€‚

```vba
' // MdlMatcher (æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) //
Option Explicit

' ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®é‡ã¿è¨­å®šï¼ˆé‡è¦åº¦ï¼‰
Private Const W_QTY As Double = 1.5 ' æ•°é‡èª¤å·®ã®é‡ã¿ï¼ˆæ•°é‡ã®æ–¹ãŒé‡è¦ãªã‚‰é«˜ã‚ã«ï¼‰
Private Const W_DATE As Double = 1.0 ' ç´æœŸèª¤å·®ã®é‡ã¿

' ç´æœŸèª¤å·®ã‚¹ã‚³ã‚¢ã®æ„Ÿåº¦è¨­å®š
Private Const DATE_BASE As Double = 14 ' ç´æœŸèª¤å·®14æ—¥ãã‚‰ã„ã§ã‚¹ã‚³ã‚¢ãŒå¤§ããä¸‹ãŒã‚‹ã‚ˆã†ã«è¨­å®š
Private Const DATE_POWER As Double = 2 ' ç´æœŸèª¤å·®ã‚’äºŒä¹—ã§å³ã—ãè©•ä¾¡ (p=2)

' --------------------------------------------------------------------------------
' ä»¥ä¸‹ã®é–¢æ•°ã§ã€æ³¨æ–‡ã¨å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
' --------------------------------------------------------------------------------
Function CalculateGroupScore( _
    ByVal OrderQty As Long, ByVal OrderDate As Date, _
    ByVal Deliveries As Collection) As Double
    
    Dim TotalDelvQty As Long
    Dim DateSum As Double
    Dim DelvCount As Long
    Dim AvgDelvDate As Date
    Dim AbsQtyError As Double
    Dim AbsDateError As Double
    Dim QtyScore As Double
    Dim DateScore As Double
    Dim Delivery As ClsDelivery ' ç´å“ã‚¯ãƒ©ã‚¹ã¯ä»®å®š

    TotalDelvQty = 0
    DateSum = 0
    DelvCount = Deliveries.Count
    
    ' ç´å“ãŒãªã„å ´åˆã¯ã‚¹ã‚³ã‚¢ã‚¼ãƒ­
    If DelvCount = 0 Then
        CalculateGroupScore = 0
        Exit Function
    End If
    
    ' ç´å“ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    For Each Delivery In Deliveries
        TotalDelvQty = TotalDelvQty + Delivery.Quantity
        DateSum = DateSum + CDbl(Delivery.DeliveryDate)
    Next Delivery
    
    ' --- 1. æ•°é‡ã‚¹ã‚³ã‚¢ ---
    AbsQtyError = Abs(OrderQty - TotalDelvQty)
    ' èª¤å·®ãŒ0ã®ã¨ã1.0ã€èª¤å·®ãŒå¤§ãããªã‚‹ã«ã¤ã‚Œ0ã«è¿‘ã¥ã
    QtyScore = 1# / (1# + AbsQtyError)
    
    ' --- 2. ç´æœŸã‚¹ã‚³ã‚¢ ---
    AvgDelvDate = DateAdd("d", 0, DateSum / DelvCount)
    AbsDateError = Abs(DateDiff("d", OrderDate, AvgDelvDate)) ' æ—¥æ•°å·®
    
    ' å¤§ããªèª¤å·®ã‚’å³ã—ãè©•ä¾¡ (Base / (Base + Error^p))
    DateScore = DATE_BASE / (DATE_BASE + (AbsDateError ^ DATE_POWER))
    
    ' --- 3. ç·åˆã‚¹ã‚³ã‚¢ ---
    CalculateGroupScore = (W_QTY * QtyScore) + (W_DATE * DateScore)

End Function
```

### 2\. å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆã¨æœ€é©åŒ–ï¼ˆMdlMatcherå†…ï¼‰

ã“ã®é–¢æ•°ãŒã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ ¸ã§ã™ã€‚å†å¸°çš„ã«ç´å“ã‚’æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

```vba
' // MdlMatcher (æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) //
' --------------------------------------------------------------------------------
' å“ç•ªã”ã¨ã®æœ€é©ãƒãƒƒãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
' --------------------------------------------------------------------------------
Sub FindOptimalMatch( _
    ByVal Orders As Collection, _
    ByVal Deliveries As Collection)
    
    ' å‡¦ç†ã‚’ç°¡ç•¥åŒ–ã™ã‚‹ãŸã‚ã€Deliveriesã¯ç´å“æ—¥ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã¨ä»®å®š
    
    Dim BestTotalScore As Double
    Dim OptimalPattern As Collection
    
    Set OptimalPattern = New Collection
    BestTotalScore = -1# ' åˆæœŸå€¤ã¨ã—ã¦ã‚ã‚Šãˆãªã„ä½ã„ã‚¹ã‚³ã‚¢ã‚’è¨­å®š
    
    ' å†å¸°å‡¦ç†ã‚’é–‹å§‹
    ' å¼•æ•°: ç´å“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³, æœ€é©ã‚¹ã‚³ã‚¢, æœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³
    Call RecursiveMatch( _
        Deliveries, 1, Orders, New Collection, _
        BestTotalScore, OptimalPattern)
        
    ' OptimalPatternãŒæœ€çµ‚çš„ãªçµæœã§ã™
    If OptimalPattern.Count > 0 Then
        Debug.Print "æœ€é©ã‚¹ã‚³ã‚¢: " & BestTotalScore
        ' å®Ÿéš›ã«Excelã«å‡ºåŠ›ã™ã‚‹å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
    Else
        Debug.Print "ãƒãƒƒãƒãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
    End If

End Sub

' --------------------------------------------------------------------------------
' å†å¸°çš„ã«ç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (Backtracking)
' --------------------------------------------------------------------------------
Private Sub RecursiveMatch( _
    ByVal AllDeliveries As Collection, _
    ByVal CurrentDelvIndex As Long, _
    ByVal AllOrders As Collection, _
    ByVal CurrentPattern As Collection, _
    ByRef BestTotalScore As Double, _
    ByRef OptimalPattern As Collection)
    
    ' ç´å“ãƒ‡ãƒ¼ã‚¿ã¯ã€Œç´å“æ—¥ã€æ˜‡é †ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã¨ä»®å®š
    
    Dim i As Long
    Dim PatternCopy As Collection
    Dim CurrentDelivery As ClsDelivery ' ç´å“ã‚¯ãƒ©ã‚¹ã¯ä»®å®š
    Dim TargetOrder As ClsOrder ' æ³¨æ–‡ã‚¯ãƒ©ã‚¹ã¯ä»®å®š
    
    ' === çµ‚äº†æ¡ä»¶: å…¨ã¦ã®ç´å“ã‚’å‰²ã‚Šå½“ã¦çµ‚ãˆãŸå ´åˆ ===
    If CurrentDelvIndex > AllDeliveries.Count Then
        ' ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
        Dim CurrentTotalScore As Double
        CurrentTotalScore = CalculateTotalScore(CurrentPattern)
        
        ' æœ€é©ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
        If CurrentTotalScore > BestTotalScore Then
            BestTotalScore = CurrentTotalScore
            Set OptimalPattern = CopyPattern(CurrentPattern) ' ãƒ‘ã‚¿ãƒ¼ãƒ³å…¨ä½“ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
        End If
        Exit Sub
    End If
    
    Set CurrentDelivery = AllDeliveries.Item(CurrentDelvIndex)
    
    ' === å‡¦ç†: CurrentDelivery ã‚’ã©ã®æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã‚‹ã‹ ===
    
    ' 1. æ—¢å­˜ã®æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã™ã‚‹
    For i = 1 To CurrentPattern.Count
        Set TargetOrder = CurrentPattern.Item(i) ' Orderã‚¯ãƒ©ã‚¹ã‚’ä»®å®š
        
        ' ç´å“æ—¥ã®åˆ¶ç´„ãƒã‚§ãƒƒã‚¯: ç´å“æ—¥ï¼ˆCurrentDelivery.DeliveryDateï¼‰ãŒã€
        ' ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®æ³¨æ–‡ç´æœŸï¼ˆTargetOrder.DueDateï¼‰ã‚ˆã‚Šã‚‚å¾Œã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ
        ' ç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®æ³¨æ–‡ç´æœŸã‚ˆã‚Šå‰ã«ãªã£ã¦ã„ãªã„ã‹ï¼Ÿ
        
        ' *** é‡è¦ãªåˆ¶ç´„ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰***
        ' ã“ã“ã§ã¯ã€å˜ç´”ã«ç¾åœ¨ã®ç´å“ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®
        ' æ³¨æ–‡ç´æœŸã‚ˆã‚Šã‚‚ã€ç¾åœ¨ã®ç´å“æ—¥è‡ªä½“ãŒå¤§ããé…ã‚Œã¦ã„ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
        
        ' å†å¸°å‘¼å‡ºã—ã®ãŸã‚ã«CurrentPatternã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ãŒå¿…è¦ï¼‰
        Set PatternCopy = CopyPattern(CurrentPattern)
        
        ' iç•ªç›®ã®æ³¨æ–‡ã«ç¾åœ¨ã®ç´å“ã‚’è¿½åŠ 
        ' PatternCopy.Item(i).Deliveries.Add CurrentDelivery ' ã“ã®æ“ä½œã¯ClsOrderå†…ã§è¡Œã†
        
        ' æ¬¡ã®ç´å“ã¸
        Call RecursiveMatch(AllDeliveries, CurrentDelvIndex + 1, AllOrders, PatternCopy, BestTotalScore, OptimalPattern)
        
    Next i
    
    ' 2. æ–°ã—ã„æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã¨ã—ã¦å‰²ã‚Šå½“ã¦ã‚‹ (ç´å“ãŒã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒã‚ã‚‹å ´åˆ)
    If CurrentPattern.Count < AllOrders.Count Then
        ' AllOrdersã®ã†ã¡ã€CurrentPatternã«ã¾ã ãªã„æ³¨æ–‡ã‚’æ¢ã—ã€ãã‚Œã«CurrentDeliveryã‚’å‰²ã‚Šå½“ã¦ã‚‹
        
        ' ... (æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç”Ÿæˆã—ã¦å†å¸°å‘¼å‡ºã—) ...
    End If
    
End Sub

' --------------------------------------------------------------------------------
' ãƒ‘ã‚¿ãƒ¼ãƒ³å…¨ä½“ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹è£œåŠ©é–¢æ•°
' --------------------------------------------------------------------------------
Function CalculateTotalScore(ByVal CurrentPattern As Collection) As Double
    Dim TotalScore As Double
    Dim OrderGroup As ClsOrder ' æ³¨æ–‡ã‚¯ãƒ©ã‚¹ã‚’ä»®å®š

    TotalScore = 0
    For Each OrderGroup In CurrentPattern
        ' OrderGroupå†…ã®ç´å“æƒ…å ±ã‚’ä½¿ã£ã¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
        TotalScore = TotalScore + CalculateGroupScore( _
            OrderGroup.Quantity, OrderGroup.DueDate, OrderGroup.Deliveries)
    Next OrderGroup
    CalculateTotalScore = TotalScore
End Function

' --------------------------------------------------------------------------------
' ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã™ã‚‹è£œåŠ©é–¢æ•°
' --------------------------------------------------------------------------------
Private Function CopyPattern(ByVal SourcePattern As Collection) As Collection
    ' ... (è¤‡é›‘ãªãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã€‚å…¨è¦ç´ ã‚’å†å¸°çš„ã«è¤‡è£½ã™ã‚‹å¿…è¦ãŒã‚ã‚‹) ...
    Set CopyPattern = New Collection ' æš«å®š
End Function
```

### è£œè¶³äº‹é …ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1.  **è¨ˆç®—é‡:** ã“ã®ã€Œå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆã€ã¯ã€ç´å“æ•°ã¨æ³¨æ–‡æ•°ã«ã‚ˆã£ã¦ã¯**çµ„ã¿åˆã‚ã›çˆ†ç™º**ã‚’èµ·ã“ã—ã€è¨ˆç®—æ™‚é–“ãŒéç¾å®Ÿçš„ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿãƒ‡ãƒ¼ã‚¿ã§è©¦è¡Œã—ã€é…ã™ãã‚‹å ´åˆã¯\*\*ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚¹ï¼ˆé™å®šæ¢ç´¢ï¼‰\*\*ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2.  **åˆ¶ç´„ã®è¤‡é›‘ã•:** ã€Œç´å“æ—¥ã¯ç´å“æ—¥ã®é †ç•ªé€šã‚Šã«ä¸¦ã¹ã‚‹ã€ã¨ã„ã†åˆ¶ç´„ã¯ã€å†å¸°é–¢æ•°ã®å†…éƒ¨ã§ã€**ç¾åœ¨å‰²ã‚Šå½“ã¦ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®æ³¨æ–‡ç´æœŸ**ã¨ã€**ãã‚Œã‚ˆã‚Šå¾Œã®ç´å“ã«ã™ã§ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã®æ³¨æ–‡ç´æœŸ**ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã§å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚
3.  **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹:** `ClsOrder`ã‚„`ClsDelivery`ã®å®šç¾©ãŒå¿…è¦ã§ã™ã€‚ï¼ˆä¾‹: `Public Quantity As Long`, `Public DueDate As Date`ãªã©ï¼‰ã€‚

å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆé…åˆ—A, é…åˆ—Bï¼‰ã®èª­ã¿è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã¨ã€ä¸Šè¨˜ã§çœç•¥ã—ãŸã‚¯ãƒ©ã‚¹å®šç¾©ãŒå¿…è¦ã§ã—ãŸã‚‰ã€ãã¡ã‚‰ã‚‚ç¶šã‘ã¦ä½œæˆã„ãŸã—ã¾ã™ã€‚



æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚è¤‡é›‘ãªãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã€**ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ã¨**æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ã‚’å«ã‚€VBAã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®å®Ÿè£…ã§ã¯ã€æ³¨æ–‡ã¨ç´å“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚·ãƒ¼ãƒˆä¸Šã‹ã‚‰èª­ã¿è¾¼ã‚€ã“ã¨ã‚’æƒ³å®šã—ã€`Sheet1`ã«é…åˆ—Aï¼ˆæ³¨æ–‡ï¼‰ã€`Sheet2`ã«é…åˆ—Bï¼ˆç´å“ï¼‰ãŒã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚

-----

## 1\. ğŸ“‚ ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©

ä»¥ä¸‹ã®3ã¤ã®ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ãƒ»ç®¡ç†ã—ã¾ã™ã€‚

### 1-1. `ClsOrder` (æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿)

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | å‹ | èª¬æ˜ |
| :--- | :--- | :--- |
| `ItemCode` | `String` | å“ç•ª |
| `OrderNo` | `String` | æ³¨æ–‡NO (ãƒ¦ãƒ‹ãƒ¼ã‚¯) |
| `Quantity` | `Long` | æ³¨æ–‡æ•°é‡ |
| `DueDate` | `Date` | æ³¨æ–‡ç´æœŸ |
| `Deliveries` | `Collection` | å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ`ClsDelivery`ã®ãƒªã‚¹ãƒˆ |

```vba
' // ClsOrder (ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) //

Private pItemCode As String
Private pOrderNo As String
Private pQuantity As Long
Private pDueDate As Date
Private pDeliveries As Collection

Private Sub Class_Initialize()
    Set pDeliveries = New Collection
End Sub

Public Property Get ItemCode() As String
    ItemCode = pItemCode
End Property
Public Property Let ItemCode(Value As String)
    pItemCode = Value
End Property

Public Property Get OrderNo() As String
    OrderNo = pOrderNo
End Property
Public Property Let OrderNo(Value As String)
    pOrderNo = Value
End Property

Public Property Get Quantity() As Long
    Quantity = pQuantity
End Property
Public Property Let Quantity(Value As Long)
    pQuantity = Value
End Property

Public Property Get DueDate() As Date
    DueDate = pDueDate
End Property
Public Property Let DueDate(Value As Date)
    pDueDate = Value
End Property

Public Property Get Deliveries() As Collection
    Set Deliveries = pDeliveries
End Property

' ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
Public Function DeepCopy() As ClsOrder
    Dim NewOrder As New ClsOrder
    Dim Delv As ClsDelivery

    NewOrder.ItemCode = Me.ItemCode
    NewOrder.OrderNo = Me.OrderNo
    NewOrder.Quantity = Me.Quantity
    NewOrder.DueDate = Me.DueDate
    
    ' å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ã‚‚ã‚³ãƒ”ãƒ¼ã™ã‚‹
    For Each Delv In Me.Deliveries
        NewOrder.Deliveries.Add Delv ' ClsDeliveryã¯å€¤ã‚’å¤‰æ›´ã—ãªã„ãŸã‚ã€å‚ç…§æ¸¡ã—ã§OK
    Next Delv
    
    Set DeepCopy = NewOrder
End Function
```

### 1-2. `ClsDelivery` (ç´å“ãƒ‡ãƒ¼ã‚¿)

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | å‹ | èª¬æ˜ |
| :--- | :--- | :--- |
| `ItemCode` | `String` | å“ç•ª |
| `WarehouseNo` | `String` | å€‰åº«ç•ªå· |
| `DeliveryDate` | `Date` | ç´å“æ—¥ |
| `Quantity` | `Long` | ç´å“æ•°é‡ |

```vba
' // ClsDelivery (ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) //

Private pItemCode As String
Private pWarehouseNo As String
Private pDeliveryDate As Date
Private pQuantity As Long

' (Getter/Setterã¯çœç•¥ã—ã¾ã™ãŒã€ClsOrderã¨åŒæ§˜ã«å®Ÿè£…ã—ã¦ãã ã•ã„)

Public Property Get ItemCode() As String
    ItemCode = pItemCode
End Property
Public Property Let ItemCode(Value As String)
    pItemCode = Value
End Property

Public Property Get DeliveryDate() As Date
    DeliveryDate = pDeliveryDate
End Property
Public Property Let DeliveryDate(Value As Date)
    pDeliveryDate = Value
End Property

Public Property Get Quantity() As Long
    Quantity = pQuantity
End Property
Public Property Let Quantity(Value As Long)
    pQuantity = Value
End Property

Public Property Get WarehouseNo() As String
    WarehouseNo = pWarehouseNo
End Property
Public Property Let WarehouseNo(Value As String)
    pWarehouseNo = Value
End Property
```

-----

## 2\. ğŸš€ æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©

`MdlMatcher`ã«å…¨ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’é›†ç´„ã—ã¾ã™ã€‚

### 2-1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ãƒ¡ã‚¤ãƒ³å‡¦ç†

```vba
' // MdlMatcher (æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) //
Option Explicit

' â˜… ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®é‡ã¿è¨­å®šï¼ˆé‡è¦åº¦ï¼‰
Private Const W_QTY As Double = 1.5      ' æ•°é‡èª¤å·®ã®é‡ã¿
Private Const W_DATE As Double = 1.0     ' ç´æœŸèª¤å·®ã®é‡ã¿

' â˜… ç´æœŸèª¤å·®ã‚¹ã‚³ã‚¢ã®æ„Ÿåº¦è¨­å®š
Private Const DATE_BASE As Double = 10   ' ç´æœŸèª¤å·®10æ—¥ã‚’åŸºæº–ã¨ã™ã‚‹
Private Const DATE_POWER As Double = 2   ' ç´æœŸèª¤å·®ã‚’äºŒä¹—ã§å³ã—ãè©•ä¾¡ (p=2)

' ãƒãƒƒãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£
Sub RunOptimalMatching()
    Dim OrderGroups As Object ' Dictionary (Key: å“ç•ª, Value: Collection of ClsOrder)
    Dim DelvGroups As Object  ' Dictionary (Key: å“ç•ª, Value: Collection of ClsDelivery)
    Dim ItemCode As Variant
    
    Set OrderGroups = CreateObject("Scripting.Dictionary")
    Set DelvGroups = CreateObject("Scripting.Dictionary")
    
    ' --- 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä»®å®šï¼‰ ---
    Call LoadData(OrderGroups, DelvGroups)

    ' --- 2. å“ç•ªã”ã¨ã«ãƒãƒƒãƒãƒ³ã‚°ã‚’å®Ÿè¡Œ ---
    Dim BestPattern As Collection
    Set BestPattern = New Collection
    
    For Each ItemCode In OrderGroups.Keys
        Dim OrdersByItem As Collection
        Dim DeliveriesByItem As Collection
        Dim BestTotalScore As Double
        
        Set OrdersByItem = OrderGroups(ItemCode)
        Set DeliveriesByItem = DelvGroups(ItemCode)
        
        ' ç´å“ãƒ‡ãƒ¼ã‚¿ã‚’ç´å“æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆå¿…é ˆï¼‰
        Call SortDeliveries(DeliveriesByItem)
        
        ' æœ€é©ãƒãƒƒãƒãƒ³ã‚°ã®æ¢ç´¢
        Set BestPattern = FindOptimalMatch(OrdersByItem, DeliveriesByItem)
        
        ' --- 3. çµæœå‡ºåŠ› ---
        If BestPattern.Count > 0 Then
            Call OutputResult (ItemCode, BestPattern)
        End If
    Next ItemCode
    
    MsgBox "æœ€é©ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", vbInformation
End Sub
```

### 2-2. ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

`CalculateGroupScore` ã¯ã€å‰ã«ç¤ºã—ãŸã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚

```vba
' å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
Function CalculateGroupScore( _
    ByVal OrderItem As ClsOrder) As Double
    
    Dim TotalDelvQty As Long
    Dim DateSum As Double
    Dim DelvCount As Long
    Dim AvgDelvDate As Date
    Dim AbsQtyError As Double
    Dim AbsDateError As Double
    Dim QtyScore As Double
    Dim DateScore As Double
    Dim Delivery As ClsDelivery

    TotalDelvQty = 0
    DateSum = 0
    DelvCount = OrderItem.Deliveries.Count
    
    If DelvCount = 0 Then
        ' ç´å“ãŒå…¨ããªã„æ³¨æ–‡ã¯ã‚¹ã‚³ã‚¢ã‚’æ¥µç«¯ã«ä½ãã™ã‚‹ã‹ã€ã‚¼ãƒ­ã¨ã™ã‚‹
        CalculateGroupScore = 0.0001 ' ã‚¼ãƒ­ã«ã™ã‚‹ã¨TotalScoreã®æ¯”è¼ƒã§å•é¡ŒãŒå‡ºã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚å¾®å°å€¤
        Exit Function
    End If
    
    ' ç´å“ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    For Each Delivery In OrderItem.Deliveries
        TotalDelvQty = TotalDelvQty + Delivery.Quantity
        DateSum = DateSum + CDbl(Delivery.DeliveryDate)
    Next Delivery
    
    ' --- 1. æ•°é‡ã‚¹ã‚³ã‚¢ (èª¤å·®ãŒå°ã•ã„ã»ã©é«˜å¾—ç‚¹) ---
    AbsQtyError = Abs(OrderItem.Quantity - TotalDelvQty)
    QtyScore = 1# / (1# + AbsQtyError)
    
    ' --- 2. ç´æœŸã‚¹ã‚³ã‚¢ (èª¤å·®ãŒå°ã•ã„ã»ã©é«˜å¾—ç‚¹) ---
    AvgDelvDate = DateAdd("d", 0, DateSum / DelvCount)
    AbsDateError = Abs(DateDiff("d", OrderItem.DueDate, AvgDelvDate))
    
    ' (Base / (Base + Error^p))
    DateScore = DATE_BASE / (DATE_BASE + (AbsDateError ^ DATE_POWER))
    
    ' --- 3. ç·åˆã‚¹ã‚³ã‚¢ ---
    CalculateGroupScore = (W_QTY * QtyScore) + (W_DATE * DateScore)

End Function

' ãƒ‘ã‚¿ãƒ¼ãƒ³å…¨ä½“ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
Function CalculateTotalScore(ByVal Pattern As Collection) As Double
    Dim TotalScore As Double
    Dim OrderGroup As ClsOrder
    
    TotalScore = 0
    For Each OrderGroup In Pattern
        TotalScore = TotalScore + CalculateGroupScore(OrderGroup)
    Next OrderGroup
    
    CalculateTotalScore = TotalScore
End Function
```

### 2-3. å†å¸°çš„ãƒãƒƒãƒãƒ³ã‚° (æ ¸å¿ƒãƒ­ã‚¸ãƒƒã‚¯)

ã“ã®é–¢æ•°ãŒå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¢ç´¢ã¨æœ€é©è§£ã®æ±ºå®šã‚’è¡Œã„ã¾ã™ã€‚

```vba
' æœ€é©ãƒãƒƒãƒãƒ³ã‚°ã®æ¢ç´¢ã‚’é–‹å§‹ã—ã€æœ€é©ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆCollection of ClsOrderï¼‰ã‚’è¿”ã™
Function FindOptimalMatch( _
    ByVal AllOrders As Collection, _
    ByVal AllDeliveries As Collection) As Collection
    
    Dim BestTotalScore As Double
    Dim OptimalPattern As Collection
    
    Set OptimalPattern = New Collection
    BestTotalScore = -1#
    
    ' RecursiveMatch (ç´å“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, ç¾åœ¨ã®å‰²ã‚Šå½“ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³)
    Call RecursiveMatch( _
        AllDeliveries, 1, AllOrders, New Collection, _
        BestTotalScore, OptimalPattern)
        
    Set FindOptimalMatch = OptimalPattern
End Function

' å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†å¸°çš„ã«ç”Ÿæˆã—ã€ã‚¹ã‚³ã‚¢ã‚’è©•ä¾¡ã™ã‚‹é–¢æ•°
Private Sub RecursiveMatch( _
    ByVal AllDeliveries As Collection, _
    ByVal CurrentDelvIndex As Long, _
    ByVal AllOrders As Collection, _
    ByVal CurrentPattern As Collection, _
    ByRef BestTotalScore As Double, _
    ByRef OptimalPattern As Collection)
    
    Dim CurrentDelivery As ClsDelivery
    Dim i As Long
    Dim PatternCopy As Collection
    Dim CurrentOrder As ClsOrder

    ' === çµ‚äº†æ¡ä»¶: å…¨ã¦ã®ç´å“ã‚’å‰²ã‚Šå½“ã¦çµ‚ãˆãŸå ´åˆ ===
    If CurrentDelvIndex > AllDeliveries.Count Then
        ' å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚‰ã‚’Patternã«è¿½åŠ ï¼ˆç´å“ã‚¼ãƒ­ã¨ã—ã¦è©•ä¾¡ã™ã‚‹ãŸã‚ï¼‰
        Dim OrderFound As Boolean
        Dim OrderToCheck As ClsOrder
        Dim PatternOrderNo As Object ' Dictionaryã¨ã—ã¦ä½¿ã†
        Set PatternOrderNo = CreateObject("Scripting.Dictionary")
        
        For Each CurrentOrder In CurrentPattern
            PatternOrderNo(CurrentOrder.OrderNo) = True
        Next CurrentOrder
        
        Set PatternCopy = CopyPattern(CurrentPattern)
        For Each OrderToCheck In AllOrders
            If Not PatternOrderNo.Exists(OrderToCheck.OrderNo) Then
                PatternCopy.Add OrderToCheck.DeepCopy ' ç´å“ã‚¼ãƒ­ã®æ³¨æ–‡ã‚’è¿½åŠ 
            End If
        Next OrderToCheck
        
        ' ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã€æœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
        Dim CurrentTotalScore As Double
        CurrentTotalScore = CalculateTotalScore(PatternCopy)
        
        If CurrentTotalScore > BestTotalScore Then
            BestTotalScore = CurrentTotalScore
            Set OptimalPattern = PatternCopy
        End If
        Exit Sub
    End If
    
    Set CurrentDelivery = AllDeliveries.Item(CurrentDelvIndex)
    
    ' === å‡¦ç†: CurrentDelivery ã‚’ã©ã®æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã‚‹ã‹ ===
    
    ' 1. æ—¢å­˜ã®æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã™ã‚‹ (CurrentPattern.Count <= AllOrders.Count)
    For i = 1 To CurrentPattern.Count
        Set CurrentOrder = CurrentPattern.Item(i)
        
        ' â˜… ç´å“æ—¥ã®åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¦ï¼‰ï¼š
        ' iç•ªç›®ã®æ³¨æ–‡ç´æœŸãŒã€i+1ç•ªç›®ä»¥é™ã®æ³¨æ–‡ç´æœŸã‚ˆã‚Šã‚‚ã€Œå‰ã€ã«ãªã£ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
        ' ã“ã“ã§ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã«ç´å“æ—¥ã®é †åºæ€§ã‚’æ‹…ä¿ã™ã‚‹åˆ¶ç´„ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
        
        ' ç´å“æ—¥ã®é †åºã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯ï¼ˆç´å“æ—¥é †ã«ä¸¦ã¹ãŸç´å“ãƒ‡ãƒ¼ã‚¿ãŒã€æ³¨æ–‡ç´æœŸé †ã«ç´ã¥ã„ã¦ã„ã‚‹ã‹ï¼‰
        If IsValidOrderDateSequence(CurrentPattern, i, AllOrders) Then
            
            ' å†å¸°å‘¼å‡ºã—ã®ãŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚³ãƒ”ãƒ¼
            Set PatternCopy = CopyPattern(CurrentPattern)
            
            ' iç•ªç›®ã®æ³¨æ–‡ã«ç¾åœ¨ã®ç´å“ã‚’è¿½åŠ 
            PatternCopy.Item(i).Deliveries.Add CurrentDelivery
            
            ' æ¬¡ã®ç´å“ã¸
            Call RecursiveMatch(AllDeliveries, CurrentDelvIndex + 1, AllOrders, PatternCopy, BestTotalScore, OptimalPattern)
        End If
    Next i
    
    ' 2. ã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„æ–°ã—ã„æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã¨ã™ã‚‹
    If CurrentPattern.Count < AllOrders.Count Then
        ' æ¬¡ã«å‰²ã‚Šå½“ã¦ã‚‹ã¹ãæ³¨æ–‡ (AllOrdersã®ã†ã¡ã€CurrentPatternã«ã¾ã ãªã„ã‚‚ã®)
        Dim NextOrderIndex As Long
        NextOrderIndex = CurrentPattern.Count + 1
        
        ' å†å¸°å‘¼å‡ºã—ã®ãŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚³ãƒ”ãƒ¼
        Set PatternCopy = CopyPattern(CurrentPattern)
        
        ' AllOrdersã‹ã‚‰NextOrderIndexç•ªç›®ã®æ³¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ç´å“ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        Dim NewOrderGroup As ClsOrder
        Set NewOrderGroup = AllOrders.Item(NextOrderIndex).DeepCopy
        NewOrderGroup.Deliveries.Add CurrentDelivery
        
        PatternCopy.Add NewOrderGroup
        
        ' æ¬¡ã®ç´å“ã¸
        Call RecursiveMatch(AllDeliveries, CurrentDelvIndex + 1, AllOrders, PatternCopy, BestTotalScore, OptimalPattern)
    End If
    
End Sub
```

-----

### 2-4. è£œåŠ©é–¢æ•° (ãƒ€ãƒŸãƒ¼å®Ÿè£…)

ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€ã‚½ãƒ¼ãƒˆã€ã‚³ãƒ”ãƒ¼ã®é–¢æ•°ãŒå¿…è¦ã§ã™ã€‚

```vba
' ãƒ‘ã‚¿ãƒ¼ãƒ³å…¨ä½“ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã™ã‚‹è£œåŠ©é–¢æ•°
Private Function CopyPattern(ByVal SourcePattern As Collection) As Collection
    Dim NewPattern As New Collection
    Dim OrderGroup As ClsOrder
    
    ' ClsOrderã®DeepCopyãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    For Each OrderGroup In SourcePattern
        NewPattern.Add OrderGroup.DeepCopy
    Next OrderGroup
    
    Set CopyPattern = NewPattern
End Function

' ç´å“ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ (ç´å“æ—¥é †)
Sub SortDeliveries(ByRef Delivs As Collection)
    ' ç´å“æ—¥ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã¾ãŸã¯ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
    ' ï¼ˆã“ã“ã§ã¯ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®å‰æã§é€²ã‚ã¾ã™ï¼‰
End Sub

' ç´å“æ—¥ã®é †åºæ€§ãƒã‚§ãƒƒã‚¯ (ãƒ­ã‚¸ãƒƒã‚¯ã®è¤‡é›‘ã•å›é¿ã®ãŸã‚ã“ã“ã§ã¯Trueã‚’è¿”ã™)
Private Function IsValidOrderDateSequence( _
    ByVal CurrentPattern As Collection, _
    ByVal CurrentIndex As Long, _
    ByVal AllOrders As Collection) As Boolean
    
    ' ã€Œç´å“æ—¥ã¯ç´å“æ—¥ã®é †ç•ªé€šã‚Šã«ä¸¦ã¹ã‚‹ã€ã¨ã„ã†åˆ¶ç´„ã‚’ã€æ³¨æ–‡ç´æœŸã¨ã®é–¢ä¿‚ã§å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
    ' ã“ã“ã‚’å³å¯†ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€å¤§ããªç´æœŸèª¤å·®ã«ã‚ˆã‚‹ç´æœŸã®å‰å¾Œé€†è»¢ã®ã‚±ãƒ¼ã‚¹ã‚’é©åˆ‡ã«è©•ä¾¡ã§ãã¾ã™ã€‚
    ' ç´å“æ—¥ï¼ˆBã®ã‚½ãƒ¼ãƒˆé †ï¼‰ i < j ãªã‚‰ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæ³¨æ–‡ç´æœŸ A.DueDate i <= A.DueDate j ãŒç†æƒ³ã€‚
    
    IsValidOrderDateSequence = True ' ç°¡ç•¥åŒ–ã®ãŸã‚ä¸€æ—¦True
End Function

' ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (Sheet1:æ³¨æ–‡, Sheet2:ç´å“ã‚’æƒ³å®š)
Private Sub LoadData(ByRef OrderGroups As Object, ByRef DelvGroups As Object)
    ' ã“ã“ã«ã€Excelã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ClsOrder/ClsDeliveryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€
    ' å“ç•ªã”ã¨ã«Dictionaryã«æ ¼ç´ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
End Sub

' çµæœå‡ºåŠ› (æœ€çµ‚çš„ãªOptimalPatternã‚’ã‚·ãƒ¼ãƒˆã«å‡ºåŠ›)
Private Sub OutputResult(ByVal ItemCode As Variant, ByVal OptimalPattern As Collection)
    ' æœ€é©ãªå‰²ã‚Šå½“ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã€çµåˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚·ãƒ¼ãƒˆã«å‡ºåŠ›ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
    ' æ³¨æ–‡NOã¨å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç´å“ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã§è¡¨ç¤ºã—ã¾ã™ã€‚
End Sub
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã”è¦æœ›ã®**å…¨çµ„ã¿åˆã‚ã›æ¢ç´¢ã¨ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**ã‚’è¡Œã†ãŸã‚ã®éª¨çµ„ã¿ã¨ãªã‚Šã¾ã™ã€‚ç‰¹ã«å†å¸°é–¢æ•°`RecursiveMatch`å†…ã§ã®**åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ï¼ˆ`IsValidOrderDateSequence`ï¼‰ã¨ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼**ã®å®Ÿè£…ãŒã€ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ€§èƒ½ã¨æ­£ç¢ºæ€§ã‚’å·¦å³ã™ã‚‹éµã¨ãªã‚Šã¾ã™ã€‚

æ®‹ã‚Šã®è£œåŠ©é–¢æ•°ï¼ˆ`LoadData`ã€`SortDeliveries`ã€`OutputResult`ï¼‰ã¯ã€ã”ä½¿ç”¨ã®Excelã‚·ãƒ¼ãƒˆã®å…·ä½“çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«åˆã‚ã›ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

ã“ã®VBAã‚³ãƒ¼ãƒ‰ã‚’ã€Excelã®VBAã‚¨ãƒ‡ã‚£ã‚¿ã§æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã‚¯ãƒ©ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆ†ã‘ã¦è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚

-----




